<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content='width=device-width, height=device-height, initial-scale=1.0, minimum-scale=1.0, user-scalable=no, shrink-to-fit=yes'>
    <title>Unity WebGL Player | 11 Rebels Rewards</title>
    <link rel="stylesheet" href="TemplateData/style.css">

    <style>
        html {
            height: -webkit-fill-available;
        }
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            width: 100vw;
            overflow: hidden;
        }
        .ctaDiv {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            background: #fffa;
            z-index: 99;
        }
        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #startButton {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            font-size: 18px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #screenshotDiv, #confirmUrlDiv, #errorDiv {
            display: none;
        }
        #errorDiv {
            background:#aaa;
        }
        #errorText {
            text-align: center;
            width: 60vw;
            color: white;
        }
    </style>
</head>
<body>
    <!--IMAGETARGETS-->

    <video id="webcam-video" muted autoplay playsinline style="width:1px;position:absolute"></video>
    <canvas id="video-canvas" style="width:100%; height:100%; object-fit:cover; position:absolute"></canvas>
    
    <div id="preloader" style="display: none;">
        <div class="loader"></div>
    </div>
    
    <div id="unity-container" class="unity-mobile">
        <canvas id="unity-canvas" style="width: 100%; height: 100%; background: #0000; z-index: -99"></canvas>
        <canvas id="video-canvas"></canvas>
    </div>
    
    <button id="startButton">Start Experience</button>

    <div id="screenshotDiv" class="ctaDiv">
        <div style="position:relative; background-color:white; padding:10px; box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.3), 0 6px 20px 0 rgba(0, 0, 0, 0.25);">
            <img id="screenshotImg" src="" alt="screenshot" style="width:80vw; height:80vh">
            <button onclick="document.getElementById('screenshotDiv').style.display = 'none';" style="position:absolute; transform:translateY(-100%); right:0; top:0">Close</button>
        </div>
    </div>

    <div id="confirmUrlDiv" class="ctaDiv">
        <div style="position:relative; background-color:white; padding:10px; box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.3), 0 6px 20px 0 rgba(0, 0, 0, 0.25); width: 80vw; display:flex; flex-direction: column; align-items: center;">
            <p id="confirmUrlText" style="text-align: center; width:80%; overflow: hidden; text-overflow: ellipsis;">Are you sure you want to visit url.com?</p>
            <div>
                <button onclick="window.open(newUrlString, '_blank').focus(); document.getElementById('confirmUrlDiv').style.display = 'none'">VISIT SITE</button>
                <button onclick="document.getElementById('confirmUrlDiv').style.display = 'none'">GO BACK</button>
            </div>
        </div>
    </div>

    <div id="errorDiv" class="ctaDiv">
        <p id="errorText"></p>
    </div>

    <script src="arcamera.js" type="text/javascript"></script>
    <script src="itracker.js" type="text/javascript"></script>
    <script src="Build/Ashita_11Rebels.loader.js"></script>
    <script>
        var unityInstance;

        async function initialize() {
            document.getElementById('preloader').style.display = 'flex';
            document.getElementById('startButton').style.display = 'none';

            var unityCanvas = document.querySelector("#unity-canvas");
            var videoCanvas = document.querySelector("#video-canvas");
            window.arCamera = new ARCamera(unityCanvas, videoCanvas);
            window.iTracker = new ImageTracker(arCamera);
            try {
                await window.iTracker.initialize();
                console.log("ImageTracker initialized!");
                await SetupCamera();
            } catch (error) {
                console.error("Failed to initialize ImageTracker or camera. " + error);
                ShowError("Failed to initialize the experience.");
            }
        }

        var container = document.querySelector("#unity-container");
        var canvas = document.querySelector("#unity-canvas");

        async function SetupCamera() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                const rearCamera = videoDevices.find(device => 
                    !(device.label.toLowerCase().includes('front') || device.label.toLowerCase().includes('user'))
                );

                const constraints = {
                    video: {
                        deviceId: rearCamera ? { exact: rearCamera.deviceId } : undefined,
                        facingMode: rearCamera ? undefined : 'environment'
                    }
                };

                window.webcamStream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.querySelector("#webcam-video");
                video.srcObject = window.webcamStream;
                await arCamera.startWebcam(video);
                console.log("Webcam started successfully");
                StartAR();
            } catch (error) {
                console.error("Error setting up camera:", error);
                ShowError("Failed to set up the camera. Please ensure you've granted camera permissions.");
            }
        }

        function StartAR() {
            canvas.style.width = window.innerWidth + "px";
            canvas.style.height = window.innerHeight + "px";
            
            createUnityInstance(document.querySelector("#unity-canvas"), {
                dataUrl: "Build/Ashita_11Rebels.data",
                frameworkUrl: "Build/Ashita_11Rebels.framework.js",
                codeUrl: "Build/Ashita_11Rebels.wasm",
                streamingAssetsUrl: "StreamingAssets",
                companyName: "Ashita",
                productName: "11 Rebels Rewards",
                productVersion: "1.0",
            }, (progress) => {
                // Update preloader here
                document.querySelector('.loader').style.borderTopColor = `hsl(${progress * 360}, 100%, 50%)`;
            }).then((instance) => {
                unityInstance = instance;
                document.getElementById('preloader').style.display = 'none';
                unityInstance.SendMessage('ARCamera', 'OnStartWebcamSuccess');
            });
        }

        function ShowError(error) {
            document.getElementById("errorDiv").style.display = "flex";
            document.getElementById("errorText").innerHTML = error;
        }

        function ShowScreenshot(dataUrl) {
            document.getElementById("screenshotDiv").style.display = "flex";
            document.getElementById("screenshotImg").src = dataUrl;
            document.getElementById("screenshotImg").style.width = "80vw";
            document.getElementById("screenshotImg").style.height = 80 / window.innerWidth * window.innerHeight + "vw";
        }

        function ShowConfirmUrl(url) {
            document.getElementById("confirmUrlDiv").style.display = "flex";
            window.newUrlString = url;
            document.getElementById("confirmUrlText").innerText = "Are you sure you want to visit " + url;                
        }

        document.getElementById('startButton').addEventListener('click', function() {
            initialize();
        });

        window.ITRACKER_GLOBALS = {
            INTERNAL_SMOOTHFACTOR_POS: .075,
        }
    </script>
</body>
</html>