<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content='width=device-width, height=device-height, initial-scale=1.0, minimum-scale=1.0, user-scalable=no, shrink-to-fit=yes'>
    <title>Unity WebGL Player | 11 Rebels Rewards</title>
    <link rel="stylesheet" href="TemplateData/style.css">

    <style>
        html {
            height: -webkit-fill-available;
        }
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            width: 100vw;
            overflow: hidden;
        }
        .ctaDiv {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            background: #fffa;
            z-index: 99;
        }
        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #startButton {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            font-size: 18px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #retryButton {
            padding: 10px 20px;
            font-size: 18px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }
        #screenshotDiv, #confirmUrlDiv, #errorDiv {
            display: none;
        }
        #errorDiv {
            background:#aaa;
        }
        #errorText {
            text-align: center;
            width: 60vw;
            color: white;
        }
        #unity-container {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        #unity-canvas {
            width: 100%;
            height: 100%;
            background: #000;
        }
        #video-canvas {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="unity-container" class="unity-desktop">
        <canvas id="unity-canvas"></canvas>
    </div>
    <video id="webcam-video" muted autoplay playsinline style="display:none;"></video>
    <canvas id="video-canvas"></canvas>
    
    <div id="preloader" style="display: none;">
        <div class="loader"></div>
    </div>
    
    <button id="startButton">Start Experience</button>

    <div id="screenshotDiv" class="ctaDiv">
        <div style="position:relative; background-color:white; padding:10px; box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.3), 0 6px 20px 0 rgba(0, 0, 0, 0.25);">
            <img id="screenshotImg" src="" alt="screenshot" style="width:80vw; height:80vh">
            <button onclick="document.getElementById('screenshotDiv').style.display = 'none';" style="position:absolute; transform:translateY(-100%); right:0; top:0">Close</button>
        </div>
    </div>

    <div id="confirmUrlDiv" class="ctaDiv">
        <div style="position:relative; background-color:white; padding:10px; box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.3), 0 6px 20px 0 rgba(0, 0, 0, 0.25); width: 80vw; display:flex; flex-direction: column; align-items: center;">
            <p id="confirmUrlText" style="text-align: center; width:80%; overflow: hidden; text-overflow: ellipsis;">Are you sure you want to visit url.com?</p>
            <div>
                <button onclick="window.open(newUrlString, '_blank').focus(); document.getElementById('confirmUrlDiv').style.display = 'none'">VISIT SITE</button>
                <button onclick="document.getElementById('confirmUrlDiv').style.display = 'none'">GO BACK</button>
            </div>
        </div>
    </div>

    <div id="errorDiv" class="ctaDiv">
        <p id="errorText"></p>
        <button id="retryButton" style="display: none;">Retry</button>
    </div>

    <script src="arcamera.js"></script>
    <script src="itracker.js"></script>
    <script src="Build/Ashita_11Rebels.loader.js"></script>
    <script>
        var unityInstance;
        var arCamera;
        var iTracker;

        async function initializeUnity() {
            // ... (initializeUnity function remains the same) ...
        }

        async function initializeARCamera() {
            const unityCanvas = document.querySelector("#unity-canvas");
            const videoCanvas = document.querySelector("#video-canvas");
            arCamera = new ARCamera(unityCanvas, videoCanvas);
            window.arCamera = arCamera;  // Make it globally accessible as the ARCamera class seems to expect

            // Initialize the image tracker
            iTracker = new ImageTracker(arCamera);
            try {
                await iTracker.initialize();
                console.log("ImageTracker initialized successfully");
            } catch (error) {
                console.error("Failed to initialize ImageTracker:", error);
                throw new Error("Failed to initialize ImageTracker: " + error.message);
            }
        }

        async function setupCamera() {
            const video = document.querySelector("#webcam-video");
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                console.log("Available video devices:", videoDevices);

                let rearCamera = videoDevices.find(device => 
                    !(device.label.toLowerCase().includes('front') || device.label.toLowerCase().includes('user'))
                );

                const constraints = {
                    video: rearCamera
                        ? { deviceId: { exact: rearCamera.deviceId } }
                        : { facingMode: 'environment' }
                };

                console.log("Camera constraints:", constraints);

                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        console.log("Video metadata loaded");
                        resolve();
                    };
                });
                await arCamera.startWebcam(video);
                console.log("Webcam started successfully");

                // Subscribe the image tracker to webcam updates
                arCamera.subscribeToWebcamUpdates(iTracker);
            } catch (error) {
                console.error("Error setting up camera:", error);
                throw new Error("Failed to set up camera: " + error.message);
            }
        }

        async function initialize() {
            document.getElementById('preloader').style.display = 'flex';
            document.getElementById('startButton').style.display = 'none';

            try {
                await initializeUnity();
                await initializeARCamera();
                await setupCamera();
                console.log("Initialization complete");
                // Start the AR experience
                if (typeof window.StartWebCam === 'function') {
                    window.StartWebCam();
                } else {
                    console.warn("StartWebCam function not found. The AR experience may not start correctly.");
                }
            } catch (error) {
                console.error("Initialization failed:", error);
                showError("Failed to initialize the experience: " + error.message);
            }
        }

        function showError(message) {
            document.getElementById('preloader').style.display = 'none';
            document.getElementById('errorDiv').style.display = 'flex';
            document.getElementById('errorText').textContent = message;
            document.getElementById('retryButton').style.display = 'block';
        }

        document.getElementById('startButton').addEventListener('click', initialize);
        document.getElementById('retryButton').addEventListener('click', initialize);

        // This function might be expected by arcamera.js
        window.StartWebCam = function() {
            console.log("StartWebCam called");
            if (unityInstance && typeof unityInstance.SendMessage === 'function') {
                unityInstance.SendMessage('ARCamera', 'OnStartWebcamSuccess');
            } else {
                console.warn("Unity instance or SendMessage not available");
            }
        };

        function ShowScreenshot(dataUrl) {
            document.getElementById("screenshotDiv").style.display = "flex";
            document.getElementById("screenshotImg").src = dataUrl;
            document.getElementById("screenshotImg").style.width = "80vw";
            document.getElementById("screenshotImg").style.height = 80 / window.innerWidth * window.innerHeight + "vw";
        }

        function ShowConfirmUrl(url) {
            document.getElementById("confirmUrlDiv").style.display = "flex";
            window.newUrlString = url;
            document.getElementById("confirmUrlText").innerText = "Are you sure you want to visit " + url;                
        }
    </script>
</body>
</html>